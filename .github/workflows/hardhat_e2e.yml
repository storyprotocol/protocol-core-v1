name: -> HardHat E2E Test

on:
  push:
    branches: [ yao/test_aug_29 ]
  pull_request:
    branches: [ yao/test_aug_29 ]


  workflow_dispatch:
    inputs:
      devnet_version:
        description: 'devnet; mainnet; internal-devnet'
        required: true
        default: 'aeneid'
        type: choice
        options:
          - aeneid
          - mainnet
          - internal-devnet
      erc721_address:
        description: 'ERC721 contract address'
        required: false
        default: '0x52D9aFFc0aCe89DA1bAf592963B7Ea7D19Bf2c3A'
        type: string
      oov3_address:
        description: 'Optimistic Oracle V3 address'
        required: false
        default: ''
        type: string
      deploy_oov3:
        description: 'Deploy Optimistic Oracle V3'
        required: false
        default: false
        type: boolean
      schedule:
        description: 'Schedule first before the set opertion'
        required: false
        default: true
        type: boolean
      test_grep:
        description: 'Test pattern to grep (e.g., "IP Owner execute", "AccessController") - leave empty to run all tests'
        required: false
        default: 'IP Owner execute AccessController module'
        type: string


  workflow_call:
    inputs:
      devnet_version:
        description: 'devnet; mainnet; internal-devnet'
        required: false
        default: 'internal-devnet'
        type: string
      erc721_address:
        description: 'ERC721 contract address'
        required: false
        default: '0x52D9aFFc0aCe89DA1bAf592963B7Ea7D19Bf2c3A'
        type: string
      test_grep:
        description: 'Test pattern to grep (e.g., "IP Owner execute", "AccessController") - leave empty to run all tests'
        required: false
        default: 'IP Owner execute AccessController module'
        type: string

jobs:
  print-config:
    runs-on: ubuntu-latest

    steps:
      - name: Print Inputs
        run: |
          echo "Inputs:"
          echo "devnet_version: ${{ inputs.devnet_version || github.event.inputs.devnet_version || 'internal-devnet' }}"
          echo "erc721_address: ${{ inputs.erc721_address || github.event.inputs.erc721_address || '0x52D9aFFc0aCe89DA1bAf592963B7Ea7D19Bf2c3A' }}"
          echo "oov3_address: ${{ inputs.oov3_address || github.event.inputs.oov3_address || '' }}"
          echo "deploy_oov3: ${{ inputs.deploy_oov3 || github.event.inputs.deploy_oov3 || 'false' }}"
          echo "schedule: ${{ inputs.schedule || github.event.inputs.schedule || 'true' }}"
          echo "test_grep: ${{ inputs.test_grep || github.event.inputs.test_grep || 'IP Owner execute AccessController module' }}"

  set-devnet-constants:
    runs-on: ubuntu-latest
    steps:
      - name: Devnet Version
        id: devnet_version
        run: |
          declare -A devnet_config=(
            ["aeneid"]="1315 https://aeneid.storyrpc.io"
            ["mainnet"]="1514 https://public.storyrpc.io"
            ["internal-devnet"]="1512 https://rpc.devnet.storyrpc.io"
          )

          devnet_version="${{ inputs.devnet_version || github.event.inputs.devnet_version || 'internal-devnet' }}"

          if [[ -n "${devnet_config[$devnet_version]}" ]]; then
            read -r chainid rpcurl <<< "${devnet_config[$devnet_version]}"
            
            echo "CHAINID=$chainid" >> $GITHUB_OUTPUT
            echo "RPCURL='$rpcurl'" >> $GITHUB_OUTPUT
            echo "NETWORK_VERSION=$devnet_version" >> $GITHUB_OUTPUT
          else
            echo "Unknown devnet version: $devnet_version"
            exit 1
          fi

      - name: Mock ERC20 Address
        id: mock_erc20_address
        run: |
          # this is for WIP
          echo "MOCK_ERC20_ADDRESS=0x1514000000000000000000000000000000000000" >> $GITHUB_OUTPUT
          # this is for MockERC20
          # echo "MOCK_ERC20_ADDRESS=0x688abA77b2daA886c0aF029961Dc5fd219cEc3f6" >> $GITHUB_OUTPUT
          # echo "MOCK_ERC20_ADDRESS=0xa5D13B403C22E28eE1153CFc6aB5e5f740A65611" >> $GITHUB_OUTPUT

    outputs:
      CHAINID: ${{ steps.devnet_version.outputs.CHAINID }}
      RPCURL: ${{ steps.devnet_version.outputs.RPCURL }}
      MOCK_ERC20_ADDRESS: ${{ steps.mock_erc20_address.outputs.MOCK_ERC20_ADDRESS }}
      NETWORK_VERSION: ${{ steps.devnet_version.outputs.NETWORK_VERSION }}

  prepare-erc721:
    name: Prepare ERC721 Address
    needs: set-devnet-constants
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [21.x]

    steps:
      - name: Determine ERC721 Strategy
        id: strategy
        run: |
          provided_address="${{ inputs.erc721_address || github.event.inputs.erc721_address || '' }}"
          
          # Check if any address is provided
          if [[ -n "$provided_address" ]]; then
            echo "DEPLOY_NEEDED=false" >> $GITHUB_OUTPUT
            echo "ERC721_ADDRESS=$provided_address" >> $GITHUB_OUTPUT
            echo "Using provided ERC721 address: $provided_address"
          else
            echo "DEPLOY_NEEDED=true" >> $GITHUB_OUTPUT
            echo "Will deploy new MockERC721"
          fi

      - name: Check Out Repository Code
        uses: actions/checkout@v4
        if: steps.strategy.outputs.DEPLOY_NEEDED == 'true'

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        if: steps.strategy.outputs.DEPLOY_NEEDED == 'true'

      - name: Run install
        uses: borales/actions-yarn@v4
        with:
          cmd: install
        if: steps.strategy.outputs.DEPLOY_NEEDED == 'true'

      - name: Install Dependencies
        run: forge compile
        if: steps.strategy.outputs.DEPLOY_NEEDED == 'true'

      - name: Deploy MockERC721
        id: deploy
        if: steps.strategy.outputs.DEPLOY_NEEDED == 'true'
        run: |
          echo "Deploying new MockERC721..."
          result=$(forge create --rpc-url ${{ needs.set-devnet-constants.outputs.RPCURL }} --broadcast --private-key ${{ secrets.STORY_PRIVATEKEY }} --optimize --optimizer-runs 30000 --legacy --json test/foundry/mocks/token/MockERC721.sol:MockERC721 --constructor-args "MockERC" "MockERC" 2>&1)
          echo $result
          erc721_address=$(echo $result | grep deployedTo | jq -r '.deployedTo')
          echo "Deployed new ERC721 to: $erc721_address"
          echo "ERC721_ADDRESS=$erc721_address" >> $GITHUB_OUTPUT

      - name: Set Final ERC721 Address
        id: erc721
        run: |
          if [[ "${{ steps.strategy.outputs.DEPLOY_NEEDED }}" == "true" ]]; then
            final_address="${{ steps.deploy.outputs.ERC721_ADDRESS }}"
          else
            final_address="${{ steps.strategy.outputs.ERC721_ADDRESS }}"
          fi
          echo "STORY_ERC721=$final_address" >> $GITHUB_OUTPUT
          echo "Final ERC721 address: $final_address"

    outputs:
      STORY_ERC721: ${{ steps.erc721.outputs.STORY_ERC721 }}



  deploy-oov3-sandbox:
    name: Deploy UMA Optimistic Oracle V3
    if: ${{ inputs.deploy_oov3 == true || github.event.inputs.deploy_oov3 == true }}
    needs: set-devnet-constants
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [21.x]

    steps:
      - name: Check Out Repository Code
        uses: actions/checkout@v4

      - name: Checkout dev-quickstart-oov3 repository
        uses: actions/checkout@v4
        with:
          repository: UMAprotocol/dev-quickstart-oov3
          path: dev-quickstart-oov3

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Install Dependencies
        run: |
          cd dev-quickstart-oov3
          forge install
    
      - name: Deploy UMA Optimistic Oracle V3
        id: deploy-oov3-sandbox
        run: |
          cd dev-quickstart-oov3
          echo "DEFAULT_CURRENCY=${{ needs.set-devnet-constants.outputs.MOCK_ERC20_ADDRESS }}" >> .env
          echo "DEFAULT_LIVENESS=600" >> .env
          echo "MINIMUM_BOND=0" >> .env
          source .env

          output=$(forge script script/OracleSandbox.s.sol --fork-url ${{ needs.set-devnet-constants.outputs.RPCURL }} \
                  --broadcast --private-key ${{ secrets.STORY_PRIVATEKEY }} --priority-gas-price 1 \
                  --legacy --optimize)
          echo "$output"

          oov3_address=$(echo "$output" | grep '^  Deployed Optimistic Oracle V3' | awk '{print $NF}')
          echo "OOV3_ADDRESS: $oov3_address"
          echo "OOV3_ADDRESS=$oov3_address" >> $GITHUB_OUTPUT
    outputs:
      OOV3_ADDRESS: ${{ steps.deploy-oov3-sandbox.outputs.OOV3_ADDRESS }}

  run-hardhat-test:
    name: Run E2E Test
    runs-on: ubuntu-latest
    needs: [set-devnet-constants, prepare-erc721, deploy-oov3-sandbox]
    if: always() && !failure() && !cancelled()

    strategy:
      matrix:
        node-version: [21.x]

    steps:
      - name: Check Out Repository Code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          
      - name: Run install
        uses: borales/actions-yarn@v4
        with:
          cmd: install # will run `yarn install` command

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: 'Create env file'
        run: |
          touch .env
          echo "MAINNET_PRIVATEKEY=${{ secrets.STORY_PRIVATEKEY }}" >> .env
          echo "SEPOLIA_PRIVATEKEY=${{ secrets.STORY_PRIVATEKEY }}" >> .env
          echo "STORY_PRIVATEKEY=${{ secrets.STORY_PRIVATEKEY }}" >> .env
          echo "STORY_USER1=${{ secrets.STORY_USER1 }}" >> .env
          echo "STORY_USER2=${{ secrets.STORY_USER2 }}" >> .env    
          echo "STORY_URL=${{ needs.set-devnet-constants.outputs.RPCURL }}" >> .env
          echo "STORY_CHAINID=${{ needs.set-devnet-constants.outputs.CHAINID }}" >> .env
          echo "STORY_ERC721=${{ needs.prepare-erc721.outputs.STORY_ERC721 }}" >> .env
          echo "STORY_OOV3=${{ needs.deploy-oov3-sandbox.outputs.OOV3_ADDRESS || inputs.oov3_address || github.event.inputs.oov3_address }}" >> .env

          # add one more blank line to .env
          echo "" >> .env

      - name: Run test
        run: |
          yarn prepare:test
          # run test with optional grep pattern
          test_grep="${{ inputs.test_grep || github.event.inputs.test_grep || 'IP Owner execute AccessController module' }}"
          if [[ -n "$test_grep" ]]; then
            echo "Running tests with grep pattern: $test_grep"
            npx hardhat test test/hardhat/e2e/**/*.ts --network ${{ needs.set-devnet-constants.outputs.NETWORK_VERSION }} --grep "$test_grep"
          else
            echo "Running all tests"
            npx hardhat test test/hardhat/e2e/**/*.ts --network ${{ needs.set-devnet-constants.outputs.NETWORK_VERSION }}
          fi

      - name: Upload Test Report
        uses: actions/upload-artifact@v4
        with:
          name: poc-test-report
          path: |
            ./mochawesome-report
        if: always()

      - name: Copy report to date folder
        id: create_folder
        run: |
          folder_name=$(date +%Y%m%d)
          echo "Folder name: $folder_name"

          # Determine version_name based on devnet_version
          env_name=${{ inputs.devnet_version || github.event.inputs.devnet_version || 'devnet' }}
          
          mkdir -p ./tmp/$folder_name/$env_name
          cp -R ./mochawesome-report/* ./tmp/$folder_name/$env_name

      - name: Deploy report to GitHub Pages
        if: ${{ inputs.deploy_report == 'true' }}
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./tmp
          publish_branch: gh-pages
          keep_files: true
