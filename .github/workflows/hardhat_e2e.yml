name: -> HardHat E2E Test

on:
  # push:
  #   branches:
  #     - update-e2e-test

  workflow_dispatch:
    inputs:
      devnet_version:
        description: 'devnet; mainnet; internal-devnet'
        required: true
        default: 'internal-devnet'
        type: choice
        options:
          - devnet
          - mainnet
          - internal-devnet
      erc721_address:
        description: 'ERC721 contract address (leave empty to deploy new one)'
        required: false
        default: ''
        type: string
      deploy_erc721:
        description: 'Deploy MockERC721 (ignored if erc721_address is provided)'
        required: false
        default: false
        type: boolean
      oov3_address:
        description: 'Optimistic Oracle V3 address (leave empty to deploy new one if deploy_oov3=true)'
        required: false
        default: ''
        type: string
      deploy_oov3:
        description: 'Deploy Optimistic Oracle V3 (ignored if oov3_address is provided)'
        required: false
        default: false
        type: boolean


  workflow_call:
    inputs:
      devnet_version:
        description: 'devnet; mainnet; internal-devnet'
        required: false
        default: 'internal-devnet'
        type: string
      erc721_address:
        description: 'ERC721 contract address (leave empty to deploy new one)'
        required: false
        default: ''
        type: string
      deploy_erc721:
        description: 'Deploy MockERC721 (ignored if erc721_address is provided)'
        required: false
        default: false
        type: boolean
      oov3_address:
        description: 'Optimistic Oracle V3 address (leave empty to deploy new one if deploy_oov3=true)'
        required: false
        default: ''
        type: string
      deploy_oov3:
        description: 'Deploy Optimistic Oracle V3 (ignored if oov3_address is provided)'
        required: false
        default: false
        type: boolean

jobs:
  print-config:
    runs-on: ubuntu-latest

    steps:
      - name: Print Inputs
        run: |
          echo "Inputs:"
          echo "devnet_version: ${{ inputs.devnet_version || github.event.inputs.devnet_version || 'internal-devnet' }}"
          echo "erc721_address: ${{ inputs.erc721_address || github.event.inputs.erc721_address || '' }}"
          echo "oov3_address: ${{ inputs.oov3_address || github.event.inputs.oov3_address || '' }}"
          echo "deploy_erc721: ${{ inputs.deploy_erc721 || github.event.inputs.deploy_erc721 || 'false' }}"
          echo "deploy_oov3: ${{ inputs.deploy_oov3 || github.event.inputs.deploy_oov3 || 'false' }}"

  set-devnet-constants:
    runs-on: ubuntu-latest
    steps:
      - name: Devnet Version
        id: devnet_version
        run: |
          declare -A devnet_config=(
            ["devnet"]="1315 http://r1-d.odyssey-devnet.storyrpc.io:8545"
            ["mainnet"]="1514 https://public.storyrpc.io"
            ["internal-devnet"]="1512 https://rpc.devnet.storyrpc.io"
          )

          devnet_version="${{ inputs.devnet_version || github.event.inputs.devnet_version || 'internal-devnet' }}"

          if [[ -n "${devnet_config[$devnet_version]}" ]]; then
            read -r chainid rpcurl <<< "${devnet_config[$devnet_version]}"
            
            echo "CHAINID=$chainid" >> $GITHUB_OUTPUT
            echo "RPCURL='$rpcurl'" >> $GITHUB_OUTPUT
          else
            echo "Unknown devnet version: $devnet_version"
            exit 1
          fi

      - name: Mock ERC20 Address
        id: mock_erc20_address
        run: |
          # echo "MOCK_ERC20_ADDRESS=0x1514000000000000000000000000000000000000" >> $GITHUB_OUTPUT
          echo "MOCK_ERC20_ADDRESS=0x688abA77b2daA886c0aF029961Dc5fd219cEc3f6" >> $GITHUB_OUTPUT

    outputs:
      CHAINID: ${{ steps.devnet_version.outputs.CHAINID }}
      RPCURL: ${{ steps.devnet_version.outputs.RPCURL }}
      MOCK_ERC20_ADDRESS: ${{ steps.mock_erc20_address.outputs.MOCK_ERC20_ADDRESS }}

  handle-erc721:
    name: Handle ERC721 Contract
    needs: set-devnet-constants
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [21.x]
        
    steps:
      - name: Check Out Repository Code
        uses: actions/checkout@v4
        if: ${{ inputs.erc721_address == '' && github.event.inputs.erc721_address == '' && (inputs.deploy_erc721 == true || github.event.inputs.deploy_erc721 == true) }}
        
      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        if: ${{ inputs.erc721_address == '' && github.event.inputs.erc721_address == '' && (inputs.deploy_erc721 == true || github.event.inputs.deploy_erc721 == true) }}
        
      - name: Run install
        uses: borales/actions-yarn@v4
        if: ${{ inputs.erc721_address == '' && github.event.inputs.erc721_address == '' && (inputs.deploy_erc721 == true || github.event.inputs.deploy_erc721 == true) }}
        with:
          cmd: install
          
      - name: Install Dependencies
        if: ${{ inputs.erc721_address == '' && github.event.inputs.erc721_address == '' && (inputs.deploy_erc721 == true || github.event.inputs.deploy_erc721 == true) }}
        run: |
          forge compile
          
      - name: Set ERC721 Address
        id: set-erc721-address
        run: |
          erc721_address=${{ inputs.erc721_address || github.event.inputs.erc721_address || '' }}
          
          if [[ -n "$erc721_address" ]]; then
            echo "Using provided ERC721 address: $erc721_address"
            echo "STORY_ERC721=$erc721_address" >> $GITHUB_OUTPUT
          elif [[ "${{ inputs.deploy_erc721 || github.event.inputs.deploy_erc721 }}" == "true" ]]; then
            echo "Deploying MockERC721 contract"
            result=$(forge create --rpc-url ${{ needs.set-devnet-constants.outputs.RPCURL }} --broadcast --private-key ${{ secrets.STORY_PRIVATEKEY }} --optimize --optimizer-runs 30000 --legacy --json test/foundry/mocks/token/MockERC721.sol:MockERC721 --constructor-args "MockERC" "MockERC" 2>&1)
            echo "$result"
            erc721=$(echo "$result" | jq -r '.deployedTo')
            if [ -z "$erc721" ]; then
              erc721=$(echo "$result" | grep -o '"deployedTo": "[^"]*' | cut -d'"' -f4)
            fi
            echo "Deployed MockERC721 to: $erc721"
            echo "STORY_ERC721=$erc721" >> $GITHUB_OUTPUT
          else
            echo "No ERC721 address provided and deploy_erc721 is false. Tests will fail if an ERC721 contract is required."
            echo "STORY_ERC721=" >> $GITHUB_OUTPUT
          fi
          
    outputs:
      STORY_ERC721: ${{ steps.set-erc721-address.outputs.STORY_ERC721 }}

  handle-oov3:
    name: Handle Optimistic Oracle V3
    needs: set-devnet-constants
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [21.x]
        
    steps:
      - name: Check Out Repository Code
        uses: actions/checkout@v4
        if: ${{ inputs.oov3_address == '' && github.event.inputs.oov3_address == '' && (inputs.deploy_oov3 == true || github.event.inputs.deploy_oov3 == true) }}
        
      - name: Checkout dev-quickstart-oov3 repository
        uses: actions/checkout@v4
        if: ${{ inputs.oov3_address == '' && github.event.inputs.oov3_address == '' && (inputs.deploy_oov3 == true || github.event.inputs.deploy_oov3 == true) }}
        with:
          repository: UMAprotocol/dev-quickstart-oov3
          path: dev-quickstart-oov3
          
      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        if: ${{ inputs.oov3_address == '' && github.event.inputs.oov3_address == '' && (inputs.deploy_oov3 == true || github.event.inputs.deploy_oov3 == true) }}
        
      - name: Install Dependencies
        if: ${{ inputs.oov3_address == '' && github.event.inputs.oov3_address == '' && (inputs.deploy_oov3 == true || github.event.inputs.deploy_oov3 == true) }}
        run: |
          cd dev-quickstart-oov3
          forge install
    
      - name: Set OOV3 Address
        id: set-oov3-address
        run: |
          oov3_address=${{ inputs.oov3_address || github.event.inputs.oov3_address || '' }}
          
          if [[ -n "$oov3_address" ]]; then
            echo "Using provided OOV3 address: $oov3_address"
            echo "OOV3_ADDRESS=$oov3_address" >> $GITHUB_OUTPUT
          elif [[ "${{ inputs.deploy_oov3 || github.event.inputs.deploy_oov3 }}" == "true" ]]; then
            echo "Deploying UMA Optimistic Oracle V3"
            cd dev-quickstart-oov3
            echo "DEFAULT_CURRENCY=${{ needs.set-devnet-constants.outputs.MOCK_ERC20_ADDRESS }}" >> .env
            echo "DEFAULT_LIVENESS=600" >> .env
            echo "MINIMUM_BOND=0" >> .env
            source .env

            output=$(forge script script/OracleSandbox.s.sol --fork-url ${{ needs.set-devnet-constants.outputs.RPCURL }} \
                    --broadcast --private-key ${{ secrets.STORY_DEPLOYER_PRIVATEKEY }} --priority-gas-price 1 \
                    --legacy --optimize)
            echo "$output"

            oov3_address=$(echo "$output" | grep '^  Deployed Optimistic Oracle V3' | awk '{print $NF}')
            echo "Deployed OOV3 to: $oov3_address"
            echo "OOV3_ADDRESS=$oov3_address" >> $GITHUB_OUTPUT
          else
            echo "No OOV3 address provided and deploy_oov3 is false. Tests will fail if an OOV3 contract is required."
            echo "OOV3_ADDRESS=" >> $GITHUB_OUTPUT
          fi
          
    outputs:
      OOV3_ADDRESS: ${{ steps.set-oov3-address.outputs.OOV3_ADDRESS }}

  run-hardhat-test:
    name: Run E2E Test
    runs-on: ubuntu-latest
    needs: [set-devnet-constants, handle-erc721, handle-oov3]
    if: always() && !failure() && !cancelled()

    strategy:
      matrix:
        node-version: [21.x]

    steps:
      - name: Check Out Repository Code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          
      - name: Run install
        uses: borales/actions-yarn@v4
        with:
          cmd: install # will run `yarn install` command

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Check Required Addresses
        run: |
          erc721_address="${{ needs.handle-erc721.outputs.STORY_ERC721 }}"
          oov3_address="${{ needs.handle-oov3.outputs.OOV3_ADDRESS }}"
          
          if [[ -z "$erc721_address" ]]; then
            echo "WARNING: No ERC721 address available. Tests requiring ERC721 will fail."
          else
            echo "Using ERC721 address: $erc721_address"
          fi
          
          if [[ -z "$oov3_address" ]]; then
            echo "WARNING: No OOV3 address available. Tests requiring OOV3 will fail."
          else
            echo "Using OOV3 address: $oov3_address"
          fi

      - name: 'Create env file'
        run: |
          touch .env
          echo "MAINNET_PRIVATEKEY=${{ secrets.STORY_PRIVATEKEY }}" >> .env
          echo "SEPOLIA_PRIVATEKEY=${{ secrets.STORY_PRIVATEKEY }}" >> .env
          echo "STORY_PRIVATEKEY=${{ secrets.STORY_PRIVATEKEY }}" >> .env
          echo "STORY_USER1=${{ secrets.STORY_USER1 }}" >> .env
          echo "STORY_USER2=${{ secrets.STORY_USER2 }}" >> .env    
          echo "STORY_URL=${{ needs.set-devnet-constants.outputs.RPCURL }}" >> .env
          echo "STORY_CHAINID=${{ needs.set-devnet-constants.outputs.CHAINID }}" >> .env
          echo "STORY_ERC721=${{ needs.handle-erc721.outputs.STORY_ERC721 }}" >> .env
          echo "STORY_OOV3=${{ needs.handle-oov3.outputs.OOV3_ADDRESS }}" >> .env

          # add one more blank line to .env
          echo "" >> .env

      - name: Run test
        run: |
          yarn prepare:test
          # run test
          npx hardhat test test/hardhat/e2e/**/*.ts --network internal_devnet

      - name: Upload Test Report
        uses: actions/upload-artifact@v4
        with:
          name: poc-test-report
          path: |
            ./mochawesome-report
        if: always()

      - name: Copy report to date folder
        id: create_folder
        run: |
          folder_name=$(date +%Y%m%d)
          echo "Folder name: $folder_name"

          # Determine version_name based on devnet_version
          env_name=${{ inputs.devnet_version || github.event.inputs.devnet_version || 'devnet' }}
          
          mkdir -p ./tmp/$folder_name/$env_name
          cp -R ./mochawesome-report/* ./tmp/$folder_name/$env_name

      - name: Deploy report to GitHub Pages
        if: ${{ inputs.deploy_report == 'true' }}
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./tmp
          publish_branch: gh-pages
          keep_files: true
